//============================================================
//
// Copyright (C) 2013 Matthew Wagerfield
//
// Twitter: https://twitter.com/mwagerfield
//
// Permission is hereby granted, free of charge, to any
// person obtaining a copy of this software and associated
// documentation files (the "Software"), to deal in the
// Software without restriction, including without limitation
// the rights to use, copy, modify, merge, publish, distribute,
// sublicense, and/or sell copies of the Software, and to
// permit persons to whom the Software is furnished to do
// so, subject to the following conditions:
//
// The above copyright notice and this permission notice
// shall be included in all copies or substantial portions
// of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY
// OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT
// LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
// FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO
// EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE
// FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
// AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE
// OR OTHER DEALINGS IN THE SOFTWARE.
//
//============================================================
FSS={FRONT:0,BACK:1,DOUBLE:2},FSS.Array="function"==typeof Float32Array?Float32Array:Array,Math.PIM2=2*Math.PI,Math.PID2=Math.PI/2,Math.randomInRange=function(t,i){return t+(i-t)*Math.random()},Math.clamp=function(t,i,e){return t=Math.max(t,i),t=Math.min(t,e)},FSS.Vector3={create:function(t,i,e){var s=new FSS.Array(3);return this.set(s,t,i,e),s},clone:function(t){var i=this.create();return this.copy(i,t),i},set:function(t,i,e,s){return t[0]=i||0,t[1]=e||0,t[2]=s||0,this},setX:function(t,i){return t[0]=i||0,this},setY:function(t,i){return t[1]=i||0,this},setZ:function(t,i){return t[2]=i||0,this},copy:function(t,i){return t[0]=i[0],t[1]=i[1],t[2]=i[2],this},add:function(t,i){return t[0]+=i[0],t[1]+=i[1],t[2]+=i[2],this},addVectors:function(t,i,e){return t[0]=i[0]+e[0],t[1]=i[1]+e[1],t[2]=i[2]+e[2],this},addScalar:function(t,i){return t[0]+=i,t[1]+=i,t[2]+=i,this},subtract:function(t,i){return t[0]-=i[0],t[1]-=i[1],t[2]-=i[2],this},subtractVectors:function(t,i,e){return t[0]=i[0]-e[0],t[1]=i[1]-e[1],t[2]=i[2]-e[2],this},subtractScalar:function(t,i){return t[0]-=i,t[1]-=i,t[2]-=i,this},multiply:function(t,i){return t[0]*=i[0],t[1]*=i[1],t[2]*=i[2],this},multiplyVectors:function(t,i,e){return t[0]=i[0]*e[0],t[1]=i[1]*e[1],t[2]=i[2]*e[2],this},multiplyScalar:function(t,i){return t[0]*=i,t[1]*=i,t[2]*=i,this},divide:function(t,i){return t[0]/=i[0],t[1]/=i[1],t[2]/=i[2],this},divideVectors:function(t,i,e){return t[0]=i[0]/e[0],t[1]=i[1]/e[1],t[2]=i[2]/e[2],this},divideScalar:function(t,i){return 0!==i?(t[0]/=i,t[1]/=i,t[2]/=i):(t[0]=0,t[1]=0,t[2]=0),this},cross:function(t,i){var e=t[0],s=t[1],r=t[2];return t[0]=s*i[2]-r*i[1],t[1]=r*i[0]-e*i[2],t[2]=e*i[1]-s*i[0],this},crossVectors:function(t,i,e){return t[0]=i[1]*e[2]-i[2]*e[1],t[1]=i[2]*e[0]-i[0]*e[2],t[2]=i[0]*e[1]-i[1]*e[0],this},min:function(t,i){return i>t[0]&&(t[0]=i),i>t[1]&&(t[1]=i),i>t[2]&&(t[2]=i),this},max:function(t,i){return t[0]>i&&(t[0]=i),t[1]>i&&(t[1]=i),t[2]>i&&(t[2]=i),this},clamp:function(t,i,e){return this.min(t,i),this.max(t,e),this},limit:function(t,i,e){var s=this.length(t);return null!==i&&i>s?this.setLength(t,i):null!==e&&s>e&&this.setLength(t,e),this},dot:function(t,i){return t[0]*i[0]+t[1]*i[1]+t[2]*i[2]},normalise:function(t){return this.divideScalar(t,this.length(t))},negate:function(t){return this.multiplyScalar(t,-1)},distanceSquared:function(t,i){var e=t[0]-i[0],s=t[1]-i[1],r=t[2]-i[2];return e*e+s*s+r*r},distance:function(t,i){return Math.sqrt(this.distanceSquared(t,i))},lengthSquared:function(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]},length:function(t){return Math.sqrt(this.lengthSquared(t))},setLength:function(t,i){var e=this.length(t);return 0!==e&&i!==e&&this.multiplyScalar(t,i/e),this}},FSS.Color=function(t){this.rgb=FSS.Vector3.create(),this.hex=t||"#000000",this.set(this.hex)},FSS.Color.prototype={set:function(t){t=t.replace("#","");var i=t.length/3;return this.rgb[0]=parseInt(t.substring(0*i,1*i),16)/255,this.rgb[1]=parseInt(t.substring(1*i,2*i),16)/255,this.rgb[2]=parseInt(t.substring(2*i,3*i),16)/255,this},hexify:function(t){var i=Math.ceil(255*t).toString(16);return 1===i.length&&(i="0"+i),i},format:function(){var t=this.hexify(this.rgb[0]),i=this.hexify(this.rgb[1]),e=this.hexify(this.rgb[2]);return this.hex="#"+t+i+e,this.hex}},FSS.Light=function(t,i){this.ambient=new FSS.Color(t||"#FFFFFF"),this.diffuse=new FSS.Color(i||"#FFFFFF"),this.position=FSS.Vector3.create(),this.ray=FSS.Vector3.create()},FSS.Light.prototype={setPosition:function(t,i,e){return FSS.Vector3.set(this.position,t,i,e),this}},FSS.Vertex=function(t,i,e){this.position=FSS.Vector3.create(t,i,e)},FSS.Vertex.prototype={setPosition:function(t,i,e){return FSS.Vector3.set(this.position,t,i,e),this}},FSS.Triangle=function(t,i,e){this.a=t||new FSS.Vertex,this.b=i||new FSS.Vertex,this.c=e||new FSS.Vertex,this.u=FSS.Vector3.create(),this.v=FSS.Vector3.create(),this.centroid=FSS.Vector3.create(),this.normal=FSS.Vector3.create(),this.color=new FSS.Color,this.computeCentroid(),this.computeNormal()},FSS.Triangle.prototype={computeCentroid:function(){return this.centroid[0]=this.a.position[0]+this.b.position[0]+this.c.position[0],this.centroid[1]=this.a.position[1]+this.b.position[1]+this.c.position[1],this.centroid[2]=this.a.position[2]+this.b.position[2]+this.c.position[2],FSS.Vector3.divideScalar(this.centroid,3),this},computeNormal:function(){return FSS.Vector3.subtractVectors(this.u,this.b.position,this.a.position),FSS.Vector3.subtractVectors(this.v,this.c.position,this.a.position),FSS.Vector3.crossVectors(this.normal,this.u,this.v),FSS.Vector3.normalise(this.normal),this},render:function(t,i){return t.beginPath(),t.moveTo(this.a.position[0],this.a.position[1]),t.lineTo(this.b.position[0],this.b.position[1]),t.lineTo(this.c.position[0],this.c.position[1]),t.closePath(),t.strokeStyle=i,t.fillStyle=i,t.stroke(),t.fill(),this}},FSS.Geometry=function(){this.vertices=[],this.triangles=[],this.dirty=!1},FSS.Geometry.prototype={update:function(){if(this.dirty){var t,i;for(t=this.triangles.length-1;t>=0;t--)i=this.triangles[t],i.computeCentroid(),i.computeNormal();this.dirty=!1}return this}},FSS.Plane=function(t,i,e,s){FSS.Geometry.call(this),this.width=t||100,this.height=i||100,this.segments=e||4,this.slices=s||4,this.segmentWidth=this.width/this.segments,this.sliceHeight=this.height/this.slices;var r,n,h,o,a,c,S,u=[],l=this.width*-.5,f=.5*this.height;for(r=0;this.segments>=r;r++)for(u.push([]),n=0;this.slices>=n;n++)S=new FSS.Vertex(l+r*this.segmentWidth,f-n*this.sliceHeight),u[r].push(S),this.vertices.push(S);for(r=0;this.segments>r;r++)for(n=0;this.slices>n;n++)h=u[r+0][n+0],o=u[r+0][n+1],a=u[r+1][n+0],c=u[r+1][n+1],t0=new FSS.Triangle(h,o,a),t1=new FSS.Triangle(a,o,c),this.triangles.push(t0,t1)},FSS.Plane.prototype=Object.create(FSS.Geometry.prototype),FSS.Material=function(t,i){this.ambient=new FSS.Color(t||"#444444"),this.diffuse=new FSS.Color(i||"#FFFFFF"),this.slave=new FSS.Color},FSS.Mesh=function(t,i){this.geometry=t||new FSS.Geometry,this.material=i||new FSS.Material,this.side=FSS.FRONT,this.visible=!0},FSS.Mesh.prototype={render:function(t,i){var e,s,r,n,h,o;for(this.geometry.update(),t.lineJoin="round",t.lineWidth=1,e=this.geometry.triangles.length-1;e>=0;e--){for(s=this.geometry.triangles[e],FSS.Vector3.set(s.color.rgb),r=i.length-1;r>=0;r--)n=i[r],FSS.Vector3.subtractVectors(n.ray,n.position,s.centroid),FSS.Vector3.normalise(n.ray),o=FSS.Vector3.dot(s.normal,n.ray),this.side===FSS.FRONT?o=Math.max(o,0):this.side===FSS.BACK?o=Math.abs(Math.min(o,0)):this.side===FSS.DOUBLE&&(o=Math.max(Math.abs(o),0)),FSS.Vector3.multiplyVectors(this.material.slave.rgb,this.material.ambient.rgb,n.ambient.rgb),FSS.Vector3.add(s.color.rgb,this.material.slave.rgb),FSS.Vector3.multiplyVectors(this.material.slave.rgb,this.material.diffuse.rgb,n.diffuse.rgb),FSS.Vector3.multiplyScalar(this.material.slave.rgb,o),FSS.Vector3.add(s.color.rgb,this.material.slave.rgb);FSS.Vector3.clamp(s.color.rgb,0,1),h=s.color.format(),s.render(t,h)}return this}},FSS.Scene=function(t){t=t||{},this.canvas=t.canvas||document.createElement("canvas"),this.canvas.style.display="block",this.context=this.canvas.getContext("2d"),this.meshes=[],this.lights=[],this.width=0,this.height=0,this.halfWidth=0,this.halfHeight=0,this.setSize(canvas.width,canvas.height)},FSS.Scene.prototype={addMesh:function(t){return t instanceof FSS.Mesh&&!~this.meshes.indexOf(t)&&this.meshes.push(t),this},removeMesh:function(t){return t instanceof FSS.Mesh&&~this.meshes.indexOf(t)&&this.meshes.splice(this.meshes.indexOf(t),1),this},addLight:function(t){return t instanceof FSS.Light&&!~this.lights.indexOf(t)&&this.lights.push(t),this},removeLight:function(t){return t instanceof FSS.Light&&~this.lights.indexOf(t)&&this.lights.splice(this.lights.indexOf(t),1),this},setSize:function(t,i){return(this.width!==t||this.height!==i)&&(this.width=this.canvas.width=t,this.height=this.canvas.height=i,this.halfWidth=.5*this.width,this.halfHeight=.5*this.height,this.context.setTransform(1,0,0,-1,this.halfWidth,this.halfHeight)),this},clear:function(){return this.context.clearRect(-this.halfWidth,-this.halfHeight,this.width,this.height),this},render:function(){this.clear();var t,i;for(t=this.meshes.length-1;t>=0;t--)i=this.meshes[t],i.visible&&i.render(this.context,this.lights);return this}},FSS.Renderer=function(){},FSS.Renderer.prototype={render:function(){return this}},FSS.CanvasRenderer=function(){FSS.Renderer.call(this)},FSS.CanvasRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.CanvasRenderer.prototype.render=function(t){return FSS.Renderer.prototype.render.call(this,t),this};